<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.2.xsd">

    <changeSet id="#1102_20160823" author="rachidAityaazza">
        <createTable tableName="CUST_CRT">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="${type.boolean}">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />
            <column name="provider_id" type="BIGINT" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="name" type="VARCHAR(100)" />
            <column name="direction" type="VARCHAR(100)" />
            <column name="start_node_id" type="BIGINT" />
            <column name="end_node_id" type="BIGINT" />
            <column name="start_node_keys" type="VARCHAR(100)" />
            <column name="end_node_keys" type="VARCHAR(100)" />
            <column name="is_unique" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createSequence sequenceName="cust_crt_seq"/>
        <addPrimaryKey columnNames="id" constraintName="cust_crt_pkey"
            tableName="cust_crt" />

        <addForeignKeyConstraint baseColumnNames="provider_id"
            baseTableName="cust_crt" constraintName="fk_cust_crt_crm_provider"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />

        <addForeignKeyConstraint baseColumnNames="start_node_id"
            baseTableName="cust_crt" constraintName="fk_cust_crt_start_node"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cust_cet"/>

        <addForeignKeyConstraint baseColumnNames="end_node_id"
            baseTableName="cust_crt" constraintName="fk_cust_crt_end_node"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cust_cet"/>

    </changeSet>
	<changeSet id="#2289_20170202" author="rachidAityaazza">
        <modifyDataType tableName="CRM_CUSTOM_FIELD_TMPL" columnName="INDEX_TYPE" newDataType="VARCHAR(250)"/>
    </changeSet>
    <changeSet id="#2289_20170203" author="rachidAityaazza">
        <modifyDataType tableName="CUST_CEI" columnName="CODE" newDataType="VARCHAR(250)"/>
    </changeSet>
    <changeSet id="technical_services" author="Clément Bareth">
        <!-- Technical Services -->
        <createSequence sequenceName="technical_services_seq"/>
        <createTable tableName="technical_services">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="service_version" type="INT4" >
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="disabled" type="INT4"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="description" type="varchar(255)" />
            <column name="code" type="varchar(255)" />
            <column name="script" type="text">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="service_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="technical_services" columnNames="id"/>
        <addUniqueConstraint columnNames="name,service_version" constraintName="technical_services_name_version"
                             deferrable="false" disabled="false" initiallyDeferred="false"
                             tableName="technical_services"/>
        <createIndex tableName="technical_services" indexName="technical_services_name_index">
            <column name="name"/>
        </createIndex>
        <!-- Descriptions -->
        <createSequence sequenceName="technical_services_description_seq"/>
        <createTable tableName="technical_services_description">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="description_type" type="varchar(255)"/>
            <column name="service_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="input" defaultValue="false" type="boolean"/>
            <column name="output" defaultValue="false" type="boolean"/>
            <column name="entity_name" type="varchar(255)" />
            <column name="target_name" type="varchar(255)" />
            <column name="source_name" type="varchar(255)" />
            <column name="cet_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="crt_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="technical_services_description" columnNames="id" />
        <addForeignKeyConstraint baseTableName="technical_services_description" baseColumnNames="service_id"
                                 constraintName="fk_ts_desc_service_id" referencedTableName="technical_services"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="technical_services_description" baseColumnNames="cet_id"
                                 constraintName="fk_ts_cet_id" referencedTableName="cust_cet"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="technical_services_description" baseColumnNames="crt_id"
                                 constraintName="fk_ts_crt_id" referencedTableName="cust_crt"
                                 referencedColumnNames="id"/>
        <!-- Property description -->
        <createSequence sequenceName="property_description_seq"/>
        <createTable tableName="property_description">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="description_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cft_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="required" defaultValue="false" type="boolean"/>
            <column name="comparator" type="varchar(255)"/>
            <column name="comparison_value" type="varchar(255)"/>
            <column name="default_value" type="varchar(255)"/>
            <column name="trustness" type="INT"/>
            <column name="direction" type="varchar(255)"/>
        </createTable>
        <addPrimaryKey tableName="property_description" columnNames="id" />
        <addForeignKeyConstraint baseTableName="property_description" baseColumnNames="cft_id"
                                 constraintName="fk_prop_desc_cft_id" referencedTableName="crm_custom_field_tmpl"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="property_description" baseColumnNames="description_id"
                                 constraintName="fk_prop_desc_desc_id" referencedTableName="technical_services_description"
                                 referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="sequence_if_mysql" author="Clement Bareth" dbms="mysql">
        <createTable tableName="cust_crt_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cust_crt_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}cust_crt_seq values(1)</sql>
        <createTable tableName="technical_services_description_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="technical_services_description_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}technical_services_description_seq values(1)</sql>
        <createTable tableName="property_description_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="property_description_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}property_description_seq values(1)</sql>
        <createTable tableName="technical_services_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="technical_services_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}technical_services_seq values(1)</sql>
    </changeSet>
    <changeSet id="cet_crt_labels" author="Clement Bareth">
        <createTable tableName="cet_labels">
            <column name="cet_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName=""/>
            </column>
            <column name="label" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="cet_id_fk" baseTableName="cet_labels" baseColumnNames="cet_id"
            referencedTableName="cust_cet" referencedColumnNames="id"/>
        <addPrimaryKey tableName="cet_labels" columnNames="cet_id, label" constraintName="cet_label_pk"/>
    </changeSet>
    <changeSet id="cet_ref" author="Hien Bach">
        <createTable tableName="cet_ref">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="cet_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName=""/>
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="INT4" />
            <column name="display_sub" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="label_cet" type="varchar(100)"/>
        </createTable>
        <addForeignKeyConstraint constraintName="cet_id_fk" baseTableName="cet_ref" baseColumnNames="cet_id"
                                 referencedTableName="cust_cet" referencedColumnNames="id"/>
        <addPrimaryKey tableName="cet_ref" columnNames="id" constraintName="cet_ref_pk"/>
    </changeSet>

    <changeSet id="pre_persist_script" author="Clement Bareth">
        <addColumn tableName="cust_cet">
            <column name="pre_persist_script" type="BIGINT" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="pre_persist_script"
                                 baseTableName="cust_cet" constraintName="fk_cust_cet_pre_persist_script"
                                 deferrable="false" initiallyDeferred="false"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    </changeSet>

    <changeSet id="rename_and_add_function_version" author="Clement Bareth">
        <addColumn tableName="meveo_script_instance">
            <column name="function_version" type="INT4">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <renameColumn tableName="technical_services" oldColumnName="service_version" newColumnName="function_version"/>
    </changeSet>

     <changeSet id="setters_and_getters" author="Clement Bareth">
        <addColumn tableName="meveo_script_instance">
            <column name="getters" type="${type.json}"> </column>
        </addColumn>
         <addColumn tableName="meveo_script_instance">
            <column name="setters" type="${type.json}"> </column>
        </addColumn>
    </changeSet>

    <changeSet author="Aurélien PONÇON" id="cust_cet_unique_constraint#3394">
        <createSequence sequenceName="cust_cet_unique_constraint_seq"/>
        <createTable tableName="cust_cet_unique_constraint">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}">
                <constraints nullable="false" />
            </column>
            <column name="description" type="VARCHAR(100)" />
            <column name="code" type="VARCHAR(50)" />

            <column name="applies_to" type="VARCHAR(100)">
                <constraints nullable="false" />
            </column>
            <column name="cypher_query" type="text">
                <constraints nullable="false" />
            </column>
            <column name="trust_score" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="applicable_on_el" type="varchar(2000)" />
            <column name="order" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
        <addPrimaryKey tableName="cust_cet_unique_constraint" columnNames="id" constraintName="cust_cet_unique_constraint_pk"/>
        <addUniqueConstraint columnNames="applies_to, code" constraintName="cust_cet_unique_constraint_applies_to_code_idx"
                             deferrable="false" disabled="false" initiallyDeferred="false"
                             tableName="cust_cet_unique_constraint"/>
    </changeSet>


    <changeSet id = "createmeveo_function" author = "Hien Bach">
        <createSequence sequenceName="meveo_function_seq" />
        <createTable tableName="meveo_function">
            <column name="id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="version" type="INT4" />
            <column name="disabled" type="${type.boolean}">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(100)" defaultValue="default">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(100)" defaultValue="default"/>
            <column name="function_version" type="INT4" />
            <column name="creator" type="varchar(100)" defaultValue="default"/>
            <column name="updater" type="varchar(100)" defaultValue="default"/>
        </createTable>
        <addPrimaryKey tableName="meveo_function" columnNames="id"/>
    </changeSet>
    <changeSet id="insertmeveo_function" author = "Hien Bach">
        <sql>
            INSERT INTO meveo_function (creator, id, updated, updater, version, disabled, created, code, description, function_version)
            SELECT creator, id, updated, updater, version, disabled, created, code, description, function_version
            FROM meveo_script_instance;
        </sql>
        <sql>
            INSERT INTO meveo_function (creator, id, updated, updater, version, disabled, created, code, description, function_version)
            SELECT creator, id, updated, updater, version, disabled, created, code, description, function_version
            FROM technical_services;
        </sql>
    </changeSet>

    <changeSet id="selectmeveo_function_seq" author = "Clément Bareth">
        <comment>Currently only works for postgres</comment>
        <sql dbms="postgres">
            SELECT setval('meveo_function_seq', COALESCE((SELECT MAX(id)+1 FROM meveo_function), 1), false);
        </sql>
    </changeSet>

    <changeSet id="updatecolumnfunction_id" author = "Hien Bach">
        <renameColumn tableName="adm_notification" oldColumnName="script_instance_id" newColumnName="function_id"/>
    </changeSet>

    <changeSet id="foreignKeyfk_function_id" author = "Hien Bach">
        <addForeignKeyConstraint baseTableName="adm_notification" baseColumnNames="function_id"
                                 constraintName="fk_function_id" referencedTableName="meveo_function"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="neo4j_configuration" author="Clément Bareth">
        <createTable tableName="neo4j_configuration">
            <column name="code" type="varchar(255)">
                <constraints primaryKey="true" primaryKeyName="pk_neo4_configuration" nullable="false"/>
            </column>
            <column name="neo4j_url" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="neo4j_login" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="neo4j_password" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id = "deleteproperty_description" author = "Hien Bach">
        <sql>
            DELETE FROM property_description WHERE 1 = 1
        </sql>
        <sql>
            DELETE FROM technical_services_description WHERE 1 = 1
        </sql>
    </changeSet>

    <changeSet id="dropForeignKeyConstrainttechnical" author = "Hien Bach">
        <dropForeignKeyConstraint baseTableName="technical_services_description" constraintName="fk_ts_desc_service_id"/>
    </changeSet>

    <changeSet id="foreignKeyTechnical" author = "Hien Bach">
        <addForeignKeyConstraint baseTableName="technical_services_description" baseColumnNames="service_id"
                                 constraintName="fk_ts_desc_service_id" referencedTableName="meveo_function"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="droptabletechnical" author = "Hien Bach">
        <dropTable tableName="technical_services"/>
    </changeSet>

    <changeSet id="service_endpoint" author="Clément Bareth">
        <!-- Service endpoint -->
        <createTable tableName="service_endpoint">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="version" type="int4"/>
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="description" type="VARCHAR(255)" />
            <column name="code" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>
            <column name="creator" type="varchar(255)"/>
            <column name="updater" type="varchar(255)"/>
            <column name="service_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="synchronous" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="method" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="service_endpoint" baseColumnNames="service_id"
                                 constraintName="fk_service_endpoint_service_id" referencedTableName="meveo_function"
                                 referencedColumnNames="id" />
        <!-- Endpoint path parameter -->
        <createTable tableName="endpoint_path_parameter">
            <column name="endpoint_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="parameter_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="position" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey constraintName="pk_endpoint_path_parameter" tableName="endpoint_path_parameter" columnNames="endpoint_id,parameter_id"/>
        <sql>
            ALTER TABLE endpoint_path_parameter
            ADD CONSTRAINT endpoint_path_parameter_pos_gt_zero
            CHECK (position >= 0);
        </sql>
        <addForeignKeyConstraint baseTableName="endpoint_path_parameter" baseColumnNames="endpoint_id"
                                 constraintName="fk_endpoint_path_parameter_endpoint_id" referencedTableName="service_endpoint"
                                 referencedColumnNames="id" />
        <addForeignKeyConstraint baseTableName="endpoint_path_parameter" baseColumnNames="parameter_id"
                                 constraintName="fk_endpoint_path_parameter_parameter_id" referencedTableName="property_description"
                                 referencedColumnNames="id" />
        <!-- Parameters mapping -->
        <createTable tableName="service_parameter_mapping">
            <column name="endpoint_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="parameter_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="parameter_name" type="varchar(255)" />
            <column name="default_value" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey constraintName="pk_service_parameter_mapping" tableName="service_parameter_mapping" columnNames="endpoint_id,parameter_id"/>
        <addForeignKeyConstraint baseTableName="service_parameter_mapping" baseColumnNames="endpoint_id"
                                 constraintName="fk_service_parameter_mapping_endpoint_id" referencedTableName="service_endpoint"
                                 referencedColumnNames="id" />
        <addForeignKeyConstraint baseTableName="service_parameter_mapping" baseColumnNames="parameter_id"
                                 constraintName="fk_service_parameter_mapping_parameter_id" referencedTableName="property_description"
                                 referencedColumnNames="id" />
    </changeSet>
    <changeSet id="#105_custom_entity_category" author="Luis Mance">
        <createTable tableName="cust_cec">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cust_cec_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="description" type="varchar(255)" />
            <column name="code" type="varchar(255)" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="name" type="varchar(100)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addColumn tableName="cust_cet">
            <column name="custom_entity_category" type="BIGINT" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="custom_entity_category"
            baseTableName="cust_cet" constraintName="fk_cust_custom_entity_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="SET NULL"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cust_cec"/>
    </changeSet>
    <changeSet id="Add_TestSuites" author="Clément Bareth">
        <addColumn tableName="meveo_function">
            <column name="test_suite" type="TEXT"/>
        </addColumn>
    </changeSet>
    <changeSet id="add_custom_entity_category" author="Phu Bach">
        <createSequence sequenceName="cust_cec_seq"/>
    </changeSet>
    <changeSet id="delete_code_created_updated_from_meveo_script_instance" author="Clément Bareth">
        <dropColumn tableName="meveo_script_instance" columnName="code"/>
        <dropColumn tableName="meveo_script_instance" columnName="created"/>
        <dropColumn tableName="meveo_script_instance" columnName="updated"/>
    </changeSet>

    <changeSet id="fix_unique_cet_constraint" author="Clément Bareth">
        <dropColumn tableName="cust_cet_unique_constraint" columnName="applies_to"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="created"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="updated"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="creator"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="updater"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="version"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="id"/>
        <dropColumn tableName="cust_cet_unique_constraint" columnName="disabled"/>
        <renameColumn tableName="cust_cet_unique_constraint" oldColumnName="order" newColumnName="position"/>
        <addColumn tableName="cust_cet_unique_constraint">
            <column name="cet_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addPrimaryKey tableName="cust_cet_unique_constraint" columnNames="code, cet_id" constraintName="cust_cet_unique_constraint_pkey"/>
    </changeSet>

    <changeSet id="#3516_replace_node_and_relationships_classname_filter" author="Clément Bareth">
        <update tableName="adm_notification">
            <column name="class_name_filter" value="org.meveo.service.neo4j.graph.Neo4jEntity"/>
            <where>
                class_name_filter = 'org.neo4j.driver.v1.types.Node'
            </where>
        </update>
        <update tableName="adm_notification">
            <column name="class_name_filter" value="org.meveo.service.neo4j.graph.Neo4jRelationship"/>
            <where>
                class_name_filter = 'org.neo4j.driver.v1.types.Relationship'
            </where>
        </update>
    </changeSet>

    <changeSet id="rest_endpoint_add_jsonata" author="Clément Bareth">
        <addColumn tableName="service_endpoint">
            <column name="jsonata_transformer" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="endpoint_parmeter_id_string" author="Clément Bareth">
        <dropForeignKeyConstraint baseTableName="service_parameter_mapping" constraintName="fk_service_parameter_mapping_parameter_id"/>
        <dropForeignKeyConstraint baseTableName="endpoint_path_parameter" constraintName="fk_endpoint_path_parameter_parameter_id"/>
        <modifyDataType tableName="service_parameter_mapping" columnName="parameter_id" newDataType="varchar(255)"/>
        <modifyDataType tableName="endpoint_path_parameter" columnName="parameter_id" newDataType="varchar(255)"/>
        <addColumn tableName="service_parameter_mapping">
            <column name="multivalued" type="${type.boolean}">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="#3553" author="Clément Bareth">
        <addColumn tableName="cust_crt">
            <column name="source_name_singular" type="varchar(255)"/>
            <column name="source_name_plural" type="varchar(255)"/>
            <column name="target_name_singular" type="varchar(255)"/>
            <column name="target_name_plural" type="varchar(255)"/>
            <column name="graphql_type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#3555" author="Clément Bareth">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="identifier" type="int4"/>
        </addColumn>
        <update tableName="crm_custom_field_tmpl">
            <column name="identifier" value="0"/>
        </update>
    </changeSet>

    <changeSet id="#3557" author="Clément Bareth">
        <addColumn tableName="cust_cet">
            <column name="graphql_query_fields" type="${type.json}"/>
        </addColumn>
    </changeSet>
    
      <changeSet id="#3607_20190123" author="andrius.karpavicius">
        <addColumn tableName="cust_cet">
            <column name="store_as_table" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <update  tableName="cust_cet">
        	<column name="store_as_table" value="0"/>
    	</update>
    </changeSet>

    <changeSet id="#3594_12042019" author="Clément Bareth">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="is_summary" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <update  tableName="crm_custom_field_tmpl">
            <column name="is_summary" value="0"/>
        </update>
    </changeSet>
    <changeSet author="Hien Bach" id="meveo_script_inputs">
        <createTable tableName="meveo_script_inputs">
            <column name="meveo_script_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="script_input" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="meveo_script_instance_id, script_input" constraintName="pk_meveo_script_inputs" tableName="meveo_script_inputs" />
    </changeSet>
    <changeSet author="Hien Bach" id="meveo_script_outputs">
        <createTable tableName="meveo_script_outputs">
            <column name="meveo_script_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="script_output" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="meveo_script_instance_id, script_output" constraintName="pk_meveo_script_outputs" tableName="meveo_script_outputs" />
    </changeSet>

    <changeSet id="endpoint_returned_variable_name" author="Clément Bareth">
    	<addColumn tableName="service_endpoint">
            <column name="returned_variable_name" type="varchar(50)"/>
        </addColumn>
    </changeSet>

    <changeSet id="endpoint_serialize result" author="Clément Bareth">
        <addColumn tableName="service_endpoint">
            <column name="serialize_result" type="${type.boolean}" valueNumeric="0" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="endpoint_serialize content_type" author="Clément Bareth">
        <addColumn tableName="service_endpoint">
            <column name="content_type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#3652-Available_storages" author="Clément Bareth">
        <addColumn tableName="cust_cet">
            <column name="available_storages" type="${type.json}"/>
        </addColumn>
    </changeSet>

    <changeSet id="add_unique_constraint_meveo_function_code" author="Clément Bareth" failOnError="false">
        <addUniqueConstraint tableName="meveo_function" columnNames="code" constraintName="meveo_function_unique_code"/>
    </changeSet>

    <changeSet id="#3655-Storages" author="Clément Bareth">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="storages" type="${type.json}"/>
        </addColumn>
    </changeSet>

    <changeSet id="technical_service_drop_notnull_consraint_crt_cet" author="Clément Bareth">
        <dropNotNullConstraint columnName="cet_id" tableName="technical_services_description"/>
        <dropNotNullConstraint columnName="crt_id" tableName="technical_services_description"/>
    </changeSet>

    <changeSet id="uuid-ossp" author="Clément Bareth" dbms="postgresql">
    	<sql>CREATE EXTENSION IF NOT EXISTS "uuid-ossp";</sql>
    </changeSet>

    <changeSet id="crt_available_storages" author="Clément Bareth">
    	<addColumn tableName="cust_crt">
    		<column name="available_storages" type="${type.json}" defaultValue="[&quot;NEO4J&quot;]"/>
    	</addColumn>
    </changeSet>

    <changeSet id="use_uuid_unique_constraint" author="Clément Bareth">
        <sql>UPDATE cust_cet_unique_constraint SET cypher_query = regexp_replace(cypher_query, '(?:ID)\((\w+)\)', '\1.meveo_uuid')</sql>
    </changeSet>

</databaseChangeLog>
