<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:custom="http://manaty.net/custom"
	template="/layout/template.xhtml">

	<ui:define name="navigation">
		<ui:include src="/layout/navigation.xhtml" />
	</ui:define>

	<ui:define name="body">
	
	<script type="text/javascript">
				
				checked=false;
				function unCheckedAll (id,frm1) {
					var aa= document.getElementById(frm1);
					
					 for (var i =0; i &lt; aa.elements.length; i++){
					 if(id!=aa.elements[i].id){
					 aa.elements[i].checked = false;
					 }else{
					 var idSRV = document.getElementById(id).value ;
					 //document.getElementById("terminationPopup:selectedSRV").value=idSRV;
					 //document.getElementById("operationFrm:selectedSRVInst").value=idSRV;
					 
					 }
						 
					}
					
				}
			</script>
		
		<custom:entityPopup id="userAccountPopup"
				header="#{messages['userAccount.popup.header']}"
				backingBean="#{userAccountBean}" dataModel="#{userAccounts}"
				searchField1Label="#{messages['userAccount.code']}"
				searchField1="code"
				searchField2Label="#{messages['userAccount.name']}"
				searchField2="name"
				column1Label="#{messages['userAccount.code']}" column1="code"
				column2Label="#{messages['userAccount.name']}" column2="name" 
				filtersMap="#{userAccountBean.filters}"	>
			<!-- select link -->
			<a:commandLink value="#{messages['commons.select']}"
					reRender="formId" 
					action="#{subscriptionBean.populateAccounts(entity)}"
					oncomplete="Richfaces.hideModalPanel('userAccountPopup')">
			</a:commandLink>
		</custom:entityPopup>
		
		<custom:entityPopup id="offerPopup"
				header="#{messages['offer.popup.header']}"
				backingBean="#{offerTemplateBean}" dataModel="#{offerTemplates}"
				searchField1Label="#{messages['offerTemplate.code']}"
				searchField1="code"
				searchField2Label="#{messages['offerTemplate.description']}"
				searchField2="name"
				column1Label="#{messages['offerTemplate.code']}" column1="code"
				column2Label="#{messages['offerTemplate.description']}" column2="description" 
				filtersMap="#{offerTemplateBean.filters}"	>
			<!-- select link -->
			<a:commandLink value="#{messages['commons.select']}"
					reRender="formId" 
					action="#{subscription.setOffer(entity)}"
					oncomplete="Richfaces.hideModalPanel('offerPopup')">
			</a:commandLink>
		</custom:entityPopup>
		
		<custom:entityPopup id="oneShotChargeTmpPopup"
				header="#{messages['oneShotChargeTmp.popup.header']}"
				backingBean="#{oneShotChargeTemplateBean}" dataModel="#{oneShotChargeTemplates}"
				searchField1Label="#{messages['chargeTemplate.code']}"
				searchField1="code"
				searchField2Label="#{messages['chargeTemplate.description']}"
				searchField2="name"
				column1Label="#{messages['chargeTemplate.code']}" column1="code"
				column2Label="#{messages['chargeTemplate.description']}" column2="description" 
				filtersMap="#{oneShotChargeTemplateBean.filters}">
			<!-- select link -->
			<a:commandLink value="#{messages['commons.select']}"
					reRender="oneShotChgForm1" 
					action="#{oneShotChargeInstance.setChargeTemplate(entity)}"
					oncomplete="Richfaces.hideModalPanel('oneShotChargeTmpPopup')">
			</a:commandLink>
		</custom:entityPopup>
		
		<custom:entityPopup id="chargeTemplatePopup"
			header="#{messages['chargeTemplate.popup.header']}"
			backingBean="#{oneShotChargeTemplateBean}" dataModel="#{oneShotChargeTemplates}"
			searchField1Label="#{messages['businessEntity.code']}" searchField1="code"
			searchField2Label="#{messages['businessEntity.description']}"
			searchField2="description"
			column1Label="#{messages['businessEntity.code']}" column1="code"
			column2Label="#{messages['businessEntity.description']}"
			column2="description" filtersMap="#{oneShotChargeTemplateBean.filters}">
			<!-- select link -->
			<a:commandLink value="#{messages['commons.select']}"
				reRender="formId" action="#{oneShotChargeInstance.setChargeTemplate(entity)}"
				oncomplete="Richfaces.hideModalPanel('chargeTemplatePopup')">
			</a:commandLink>
		</custom:entityPopup>
		
		<custom:entityPopup id="recurringChargeTmpPopup"
				header="#{messages['recurringChargeTmp.popup.header']}"
				backingBean="#{recurringChargeTemplateBean}" dataModel="#{recurringChargeTemplates}"
				searchField1Label="#{messages['chargeTemplate.code']}"
				searchField1="code"
				searchField2Label="#{messages['chargeTemplate.description']}"
				searchField2="name"
				column1Label="#{messages['chargeTemplate.code']}" column1="code"
				column2Label="#{messages['chargeTemplate.description']}" column2="description" 
				filtersMap="#{recurringChargeTemplateBean.filters}">
			<!-- select link -->
			<a:commandLink value="#{messages['commons.select']}"
					reRender="recurringChgForm1" 
					action="#{recurringChargeInstance.setChargeTemplate(entity)}"
					oncomplete="Richfaces.hideModalPanel('recurringChargeTmpPopup')">
			</a:commandLink>
		</custom:entityPopup>
		
		<rich:modalPanel id="serviceTerminationPopup" keepVisualState="true" style="overflow:auto;">
	       <a:outputPanel id="terminationPanel" >
			    <custom:formPanel edit="true" label="#{messages['serviceTerminationPopup.title']}"
						 		backingBean="#{subscriptionBean}" entity="#{subscriptionBean.selectedServiceInstance}" styleClass="formPanel" formId="subscTermFrm" showFormButtons="false">
					<custom:panelGroup columns="2">
						<custom:formField label="#{messages['serviceInstance.code']}" field="code" size="50" edit="false"/>
					</custom:panelGroup>
					<custom:panelGroup columns="2">
						<custom:formField label="#{messages['serviceInstance.terminationDate']}" field="terminationDate" required="true"/>	
					</custom:panelGroup>
					<custom:panelGroup columns="2">
						<custom:formEntityField label="Motif " field="subscriptionTerminationReason"  childField="description" 
							required="true" popup="false"  service="#{subscriptionTerminationReasonService}" 
							listElements="#{subscriptionTerminationReasonService.listReasons()}"/>
							
				    </custom:panelGroup>
				    <rich:panel>
			    			<h:commandButton action="#{subscriptionBean.terminateService()}" value="#{messages['button.terminateButton']}"  onclick="Richfaces.hideModalPanel('serviceTerminationPopup');"/>&nbsp;&nbsp;
							<a:commandButton action="#{subscriptionBean.getQuantity()}" immediate="true" onclick="Richfaces.hideModalPanel('serviceTerminationPopup');" value="#{messages['management.close']}" />
					</rich:panel>				
			    </custom:formPanel>
	       </a:outputPanel>
		</rich:modalPanel>


		
	<h:panelGrid columns="1" width="100%">
		<h:panelGroup>
<div class="panels"> 	
 		  			<custom:hierarchyPanel treeValue="#{customerTreeBean.buildAccountsHierarchy(subscription)}" entity="#{subscription}"/>
				<rich:panel styleClass="formPanel"> 
				<f:facet name="header">
					<h:outputText value="#{messages['subscription.panel']}" />
				</f:facet>
<rich:tabPanel switchType="client">
<rich:tab label="#{messages['subscription.tab.services']}" rendered="#{!edit}" >
		<custom:formPanel formId="headerInfo1" edit="#{edit}" 
				backingBean="#{subscriptionBean}" entity="#{subscription}" showFormButtons="false" styleClass="formPanel">
		<custom:panelGroup columns="3">
		   	<custom:formField label="#{messages['businessEntity.code']}" field="code" required="true"/>
			<custom:formField label="#{messages['serviceInstance.status']}" field="status"/>
    		<custom:formField label="#{messages['serviceInstance.statusDate']}" field="statusDate" />
		</custom:panelGroup>
		
		<custom:panelGroup columns="3">
			<custom:formEntityField id="offerSelectId1" label="#{messages['subscription.offer']}"
								field="offer" childField="code" popup="false"/>
			<custom:formField label="#{messages['billingAccount.subscriptionDate']}" field="subscriptionDate"/>
			<custom:formField label="#{messages['billingAccount.terminationDate']}" field="terminationDate" />
		</custom:panelGroup>
	    </custom:formPanel>

	
		<br/>
	    <br/>
	    <h:outputText value="Liste des services souscrits :" style="font-weight: bold;font-size=14;" />
    		<custom:dataList dataModel="#{subscriptionBean.serviceInstances}" resultsId="SI_results1"  backingBean="#{subscriptionBean}" checkMany="false" formId="srvInstansFrm">
			
			<rich:column id="checker1" width="10" styleClass="chech-column" >
			 <h:selectOneRadio id="myRadio" value="#{subscriptionBean.selectedServiceInstanceId}" onchange="unCheckedAll(this.id,'srvInstansFrm');">
			    <f:selectItem itemValue="#{entity.id}"/> 
				<a:support ajaxSingle="true" event="onclick" reRender="terminationPanel,serviceInstOperations" action="#{subscriptionBean.setSelectedServiceInstanceId(entity.id)}"/>	
			 </h:selectOneRadio>
			 </rich:column>
    			<custom:column label="#{messages['serviceInstance.code']}" field="code" />
    			<custom:column label="#{messages['serviceInstance.status']}" field="status"  showSortLinks="false"/>
    			<custom:column label="#{messages['serviceInstance.quantity']}" field="quantity"  showSortLinks="false"/>
    			<custom:column label="#{messages['serviceInstance.statusDate']}" field="statusDate"  showSortLinks="false"/>
    			<custom:column label="#{messages['serviceInstance.description']}" field="description"  showSortLinks="false"/>
    			<custom:column label="#{messages['serviceInstance.subscriptionDate']}" field="subscriptionDate"  showSortLinks="false"/>
    			<custom:column label="#{messages['serviceInstance.endAgrementDate']}" field="endAgrementDate"  showSortLinks="false"/>
    			<custom:actionsColumn editView="/pages/resource/serviceInstances/serviceInstanceDetail.xhtml"  showSortLinks="false"/>
    			<ui:define name="operations">
    			
				</ui:define>
		    </custom:dataList> 
			<a:outputPanel id="serviceInstOperations" >
				<h:form id="operationFrm">
    			<h:commandButton action="#{subscriptionBean.activateService}"  value="#{messages['button.activateButton']}" onclick="if(confirm('#{messages['confirmationMessage.confirmActivation']}')){return true;}else{return false;}" disabled="#{subscriptionBean.selectedServiceInstanceId==null || subscriptionBean.selectedServiceInstance.status!='INACTIVE'}"/>&nbsp;&nbsp;
				<a:commandButton  value="#{messages['button.terminateButton']}" oncomplete="Richfaces.showModalPanel('serviceTerminationPopup', {height:'300px', width:'400px'});" disabled="#{subscriptionBean.selectedServiceInstanceId==null || subscriptionBean.selectedServiceInstance.status=='INACTIVE'}"/>&nbsp;&nbsp;
				<h:commandButton action="#{subscriptionBean.cancelService}" value="#{messages['button.cancelButton']}" onclick="if(confirm('#{messages['confirmationMessage.confirmCancellation']}')){return true;}else{return false;}" disabled="#{subscriptionBean.selectedServiceInstanceId==null || subscriptionBean.selectedServiceInstance.status=='INACTIVE' || subscriptionBean.selectedServiceInstance.status=='TERMINATED'}"/>&nbsp;&nbsp;
				<h:commandButton action="#{subscriptionBean.suspendService}" value="#{messages['button.suspendButton']}" onclick="if(confirm('#{messages['confirmationMessage.confirmSuspension']}')){return true;}else{return false;}" disabled="#{subscriptionBean.selectedServiceInstanceId==null || subscriptionBean.selectedServiceInstance.status=='INACTIVE' || subscriptionBean.selectedServiceInstance.status=='TERMINATED'}"/>&nbsp;&nbsp;
				
				</h:form>
			</a:outputPanel>
			
	    <br/>
	    <br/>
	    
		    <h:outputText value="Liste des services souscriptibles :" style="font-weight: bold;font-size=14;" />
		        <custom:dataList dataModel="#{subscriptionBean.serviceTemplates}" resultsId="ST_results2" checkMany="true"  backingBean="#{subscriptionBean}">
	    			<custom:column label="#{messages['serviceTemplate.code']}" field="code" />
	    			<custom:column label="#{messages['serviceTemplate.description']}" field="description" />
	    			<br/>
	    			<br/>
	    			<ui:define name="operations">
			    		 <div style="text-align: center;">
			    		 	<h:panelGrid columns="3" style="border:2px;">
								#{messages['serviceInstance.quantity']}:
								<h:inputText value="#{subscriptionBean.quantity}" size="5" maxlength="3"/>
								<a:commandButton id="cbutton" action="#{subscriptionBean.instanciateManyServices}" reRender="SI_results2_panel,SI_results1_panel,datatable,oneShotDataPanel,recurringChargeDataPanel" value="#{messages['button.instanciateButton']}"/> 
								</h:panelGrid>
			    		 </div>
					</ui:define>
			    </custom:dataList>
</rich:tab>
<rich:tab label="#{messages['billingAccount.tab.information']}">

				<custom:formPanel edit="#{edit}" label="#{messages['subscription.panel']}" backingBean="#{subscriptionBean}" entity="#{subscription}" >
		    			<!--Creation window fields-->
						<custom:formEntityField id="userSelectId" label="#{messages['subscription.userAccount']}"
								field="userAccount" childField="code" required="true" popup="true" popupId="userAccountPopup" />
						<custom:formEntityField id="offerSelectId" label="#{messages['subscription.offer']}"
								field="offer" childField="code" popup="true" popupId="offerPopup" required="true" modifyOnCreate="true"/>
						<custom:panelGroup columns="1">
							<custom:formField label="#{messages['businessEntity.code']}" field="code" required="true" validateUnique="true" size="35" maxlength="35"/>
							<custom:formField label="#{messages['businessEntity.description']}" field="description" size="80" maxlength="100"/>
						</custom:panelGroup>
						<custom:panelGroup columns="2">
						<custom:formField label="#{messages['billingAccount.subscriptionDate']}" field="subscriptionDate" />
						<custom:formField label="#{messages[subscription.status=='SUSPENDED'?'billingAccount.suspensionDate': 'billingAccount.terminationDate']}" field="terminationDate"  show="#{!edit}"/>
						</custom:panelGroup>
						<custom:panelGroup columns="1">
						<custom:formField label="#{messages['subscription.endAgrementDate']}" field="endAgrementDate"/>
						</custom:panelGroup>
						<custom:panelGroup columns="1">	
				<custom:formField label="#{messages['accountEntity.defaultLevel']}" field="defaultLevel" isMessage="true"/>
		</custom:panelGroup>
		    	</custom:formPanel>
</rich:tab>
<rich:tab label="#{messages['subscription.tab.oneShotChg']}" rendered="#{!edit}" >

<custom:formPanel formId="form3" edit="#{edit}" 
				backingBean="#{subscriptionBean}" entity="#{subscription}" showFormButtons="false" >
		<custom:panelGroup columns="3">
			<custom:formField label="#{messages['businessEntity.code']}" field="code" />
			<custom:formField label="#{messages['serviceInstance.status']}" field="status"/>
    		<custom:formField label="#{messages['serviceInstance.statusDate']}" field="statusDate" />
		</custom:panelGroup>
		<custom:panelGroup columns="3">
			<custom:formEntityField id="offerSelectId" label="#{messages['subscription.offer']}"
								field="offer" childField="code" popup="false"/>
			<custom:formField label="#{messages['billingAccount.subscriptionDate']}" field="subscriptionDate"/>
			<custom:formField label="#{messages[subscription.status=='SUSPENDED'?'billingAccount.suspensionDate': 'billingAccount.terminationDate']}" field="terminationDate" />
		</custom:panelGroup>
</custom:formPanel>
<br/>
<br/>
	<a:outputPanel id="oneShotDataPanel"> 
	 <custom:dataList dataModel="#{subscriptionBean.oneShotChargeInstances}" resultsId="OS_oneShot_results" checkMany="false"  backingBean="#{subscriptionBean}">
    		    <custom:column label="#{messages['chargeInstance.code']}" field="code" />
    			<custom:column label="#{messages['chargeInstance.description']}" field="description" isMessage="true"/>
    			<custom:column label="#{messages['oneShotChargeInstance.amountWithoutTax']}" field="amountWithoutTax"/>
    			<custom:column label="#{messages['oneShotChargeInstance.amount2']}" field="amount2"/>
    			<custom:column label="#{messages['oneShotChargeInstance.criteria1']}" field="criteria1" isMessage="true"/>
	    		<custom:column label="#{messages['oneShotChargeInstance.criteria2']}" field="criteria2" isMessage="true"/>
	    		<custom:column label="#{messages['oneShotChargeInstance.criteria3']}" field="criteria3" isMessage="true"/>
    			
    			<rich:column styleClass="actions-column">
             		<f:facet name="header">
                    	<h:outputText value="#{messages['commons.actions']}" />
             		</f:facet>
             		
             		 <a:commandLink id="editOneShotChgInsLink" reRender="oneShotChgSdiv" onclick="document.getElementById('oneShotChgDiv').style.display='';" action="#{subscriptionBean.editOneShotChargeIns(entity)}">
                		<h:graphicImage value="/img/edit.gif" style="border:0"/>
             		</a:commandLink>
             		<rich:toolTip for="editOneShotChgInsLink" value="#{messages['commons.edit']}"/>
             	</rich:column>
	</custom:dataList>
	</a:outputPanel>
	<rich:panel>
	<h:form>
		<a:commandButton value="#{messages['subscription.oneShotChgButton']}" action="#{subscriptionBean.newOneShotChargeInstance}" onclick="document.getElementById('oneShotChgDiv').style.display='';" reRender="oneShotChgSdiv"/>&nbsp;&nbsp;
	</h:form>
	<br/>
	<br/>
<div id="oneShotChgDiv" style="display:none"><s:div id="oneShotChgSdiv">
	<custom:formPanel edit="true" label="#{messages['subscription.tab.oneShotChg']}" backingBean="#{subscriptionBean}" 
			entity="#{oneShotChargeInstance}" formId="oneShotChgForm1" showFormButtons="false" ajaxSubmit="true">
			<custom:formEntityField id="chargeTemplateSelectId" label="#{messages['businessEntity.code']}"
								field="chargeTemplate" childField="code" popup="true" popupId="oneShotChargeTmpPopup"/>
				<custom:formField label="#{messages['businessEntity.description']}" field="description" size="50" maxlength="50" disabled="true"/>
				<custom:formField label="#{messages['oneShotChargeInstance.chargeDate']}" field="chargeDate" />
				<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['oneShotChargeInstance.amountWithoutTax']}" />
				</ui:define>
				<h:inputText rendered="#{edit}" id="amountWithoutTax" 
					value="#{entity.amountWithoutTax}" size="5" converter="bigDecimalConverter" onkeyup="validateAmounts();" disabled="#{!entity.chargeTemplate.amountEditable}">
					
				</h:inputText>		 			
					<h:outputText rendered="#{!edit}" value="#{entity.amountWithoutTax}" style="font-weight:bold;"  converter="bigDecimalConverter" />
				</s:decorate>
	    		
	    		<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['oneShotChargeInstance.amount2']}" /> 
				</ui:define>
				<h:inputText rendered="#{edit}" id="amount2" 
					value="#{entity.amount2}" size="5" converter="bigDecimalConverter" onkeyup="validateAmounts();" disabled="#{!entity.chargeTemplate.amountEditable}"> 
				</h:inputText>						
					<h:outputText rendered="#{!edit}" value="#{entity.amount2}" style="font-weight:bold;"  converter="bigDecimalConverter" />
				</s:decorate>
	    		<custom:formField label="#{messages['oneShotChargeInstance.criteria1']}" field="criteria1" />
	    		<custom:formField label="#{messages['oneShotChargeInstance.criteria2']}" field="criteria2" />
	    		<custom:formField label="#{messages['oneShotChargeInstance.criteria3']}" field="criteria3" />
				
				<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['serviceInstance.quantity']}" />
				</ui:define>
				<h:inputText rendered="#{edit}" id="amountWithoutTax" 
					value="#{subscriptionBean.oneShotChargeInstanceQuantity}" size="5"  maxlength="3">
				</h:inputText>		 			
				</s:decorate>				
				<a:outputPanel id="oneShotChargeApplicationsPanel" rendered="#{oneShotChargeInstance.id!=null}">
					<rich:spacer />
					<h:outputText value="#{messages['commons.noItems']}" rendered="#{empty subscriptionBean.oneShotChargeApplications}" />
					<h:panelGrid width="100%" columns="1" border="0" style="padding:0px; margin:0px;text-align: right;" rendered="#{not empty subscriptionBean.oneShotChargeApplications}">
			        	<h:outputText value="#{subscriptionBean.oneShotChargeApplications.size} #{messages['commons.itemsFound']}"/>
	           		
	           		<rich:dataTable id="oneShotChargeApplicationTable" value="#{subscriptionBean.oneShotChargeApplications}" var="shotApplication"
						onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
						onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'"
						reRender="oneShotChargeApplicationScroller" rows="10" >
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.applicationDate']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.applicationDate}" >
								<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
							</h:outputText>
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.description']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.description}" >
								<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
							</h:outputText>
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.amountWithoutTax']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.amountWithoutTax}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.amount2']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.amount2}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.status']}" />
							</f:facet>
							<h:outputText value="#{messages[shotApplication.status.label]}" />
						</rich:column>
						
					</rich:dataTable>
					<rich:datascroller id="oneShotChargeApplicationScroller" for="oneShotChargeApplicationTable" renderIfSinglePage="false" maxPages="10"/>
					</h:panelGrid>
				</a:outputPanel>
				
<script type="text/javascript">
    //<![CDATA[

    var validAmount;
    var amountWithoutTax;
    var chargeTemplate;
    var amount2;
    var calculatedAmount;
    var calculatedAmountWithoutTax;
    var formatedValue;
    var formatedValueHT;

    function caseTTCamount(){
    	if ((document.getElementById('#{rich:clientId('amount2')}').value!='')&&(document.getElementById('#{rich:clientId('amountWithoutTax')}').value=='')) 
    	{return true;} else {return false;}
    }
    function caseHTamount(){
    	if ((document.getElementById('#{rich:clientId('amount2')}').value=='')&&(document.getElementById('#{rich:clientId('amountWithoutTax')}').value!='')) 
    	{return true;} else {return false;}
    }
    function caseHTandTTCamouts(){
    	if ((document.getElementById('#{rich:clientId('amount2')}').value!='')&&(document.getElementById('#{rich:clientId('amountWithoutTax')}').value!='')) 
    	{return true;} else {return false;}
    }
	
    function getValidAmout(){
    	validateAmounts();
       	return validAmount;
    }
    function getValidFormat(amount){
    	Seam.Component.getInstance("javaScriptAction").getFormatedAmountString(amount,function(result) {formatedValue=result;});
    }
    function getValidFormatHT(amount){
    	Seam.Component.getInstance("javaScriptAction").getFormatedAmountString(amount,function(result) {formatedValueHT=result;});
    }

	function getAlertTextForCaseHTandTTCamouts(){
		var text =  'Attention : pour le Montant HT '+amountWithoutTax +', le Montant TTC attendu est '+calculatedAmount+'. Confirmez-vous les montants saisis ?';
		return text;
	}
	function getAlertTextForCaseTTCamount(){
		var text =  'Attention : pour le Montant TTC '+amount2 +', le Montant HT attendu est '+calculatedAmountWithoutTax;
		return text;
	}
	function getAlertTextForCaseHTamount(){
		var text =  'Attention : pour le Montant HT '+amountWithoutTax+', le Montant TTC attendu est '+calculatedAmount;
		return text;
	}


	var exceptionHandler = function(ex) { alert("Error: " + ex.getMessage()); };
	
	function validateAmounts(){
       	amountWithoutTax = document.getElementById('#{rich:clientId('amountWithoutTax')}').value; 
    	chargeTemplate= document.getElementById('#{rich:clientId('chargeTemplateSelectId')}').value;
    	amount2 = document.getElementById('#{rich:clientId('amount2')}').value;
    	if ((document.getElementById('#{rich:clientId('amount2')}').value=='')&&(document.getElementById('#{rich:clientId('amountWithoutTax')}').value=='')) 
    	{validAmount = true;}
    	else {
    		if(document.getElementById('#{rich:clientId('amountWithoutTax')}').value!='') {
    	Seam.Component.getInstance("javaScriptAction").calculateOneShotChargeInstanceAmount(chargeTemplate, amountWithoutTax,function(result) {calculatedAmount=result;}, exceptionHandler);
    	getValidFormatHT(amountWithoutTax);
		amountWithoutTax = formatedValueHT;
		}
    	if(document.getElementById('#{rich:clientId('amount2')}').value!='') {
    	Seam.Component.getInstance("javaScriptAction").calculateOneShotChargeInstanceAmountWithoutTax(chargeTemplate, amount2, function(result) {calculatedAmountWithoutTax=result;}, exceptionHandler);
    	getValidFormat(amount2);
		amount2 = formatedValue;
    	}
    	if (calculatedAmount==amount2)
		 {validAmount = true;}
		 else {validAmount = false;}
    	}
	}
	function validation(){
		var resultValidAmout=getValidAmout();
		if(resultValidAmout==false){
            if(caseTTCamount()==true){
                alert(getAlertTextForCaseTTCamount());
                return false;
            }
            if(caseHTamount()==true){
                alert(getAlertTextForCaseHTamount());
                return false;
            }
            if(caseHTandTTCamouts()==true){
                if(!confirm(getAlertTextForCaseHTandTTCamouts())){
                    return false;}
                }
            }
		else {
			return true;
		}
	}
	
    // ]]>
  </script>     
   
				<h:panelGrid columns="2">
					<h:commandButton action="#{subscriptionBean.saveOneShotChargeIns}" value="#{messages['action.save']}" rendered="#{currentProvider.amountValidation}">
						<a:support event="onclick" reRender="OS_oneShot_results_form" 

                    onsubmit="return validation();" 

                    oncomplete="document.getElementById('oneShotChgDiv').style.display='none';" />

					</h:commandButton>
					
					<a:commandButton action="#{subscriptionBean.saveOneShotChargeIns}" value="#{messages['action.save']}" reRender="OS_oneShot_results_form" onclick="document.getElementById('oneShotChgDiv').style.display='none';" rendered="#{!currentProvider.amountValidation}"/>
					
					
					<s:button value="#{messages['action.cancel']}" onclick="document.getElementById('oneShotChgDiv').style.display='none';"/>
				</h:panelGrid>
			</custom:formPanel>
</s:div></div>
	</rich:panel>
</rich:tab>
<!-- recurring charge instance -->
<rich:tab label="#{messages['subscription.tab.recurringShotChg']}" rendered="#{!edit}" >

<custom:formPanel formId="form4" edit="#{edit}" 
				backingBean="#{subscriptionBean}" entity="#{subscription}" showFormButtons="false" >
		<custom:panelGroup columns="3">
			<custom:formField label="#{messages['businessEntity.code']}" field="code" />
			<custom:formField label="#{messages['serviceInstance.status']}" field="status"/>
    		<custom:formField label="#{messages['serviceInstance.statusDate']}" field="statusDate" />
		</custom:panelGroup>
		<custom:panelGroup columns="3">
			<custom:formEntityField id="offerSelectId" label="#{messages['subscription.offer']}"
								field="offer" childField="code" popup="false"/>
			<custom:formField label="#{messages['billingAccount.subscriptionDate']}" field="subscriptionDate"/>
			<custom:formField label="#{messages[subscription.status=='SUSPENDED'?'billingAccount.suspensionDate': 'billingAccount.terminationDate']}" field="terminationDate" />
		</custom:panelGroup>
</custom:formPanel>
<br/>
<br/>
<a:outputPanel id="recurringChargeDataPanel"> 

	 <custom:dataList dataModel="#{subscriptionBean.recurringChargeInstances}" resultsId="OS_recurring_results" checkMany="false"  backingBean="#{subscriptionBean}">
    			<custom:column label="#{messages['chargeInstance.code']}" field="code" />
    			<custom:column label="#{messages['chargeInstance.description']}" field="description" isMessage="true"/>
    			<custom:column label="#{messages['oneShotChargeInstance.amountWithoutTax']}" field="amountWithoutTax"/>
    			<custom:column label="#{messages['oneShotChargeInstance.amount2']}" field="amount2"/>
    			<custom:column label="#{messages['oneShotChargeInstance.criteria1']}" field="criteria1" isMessage="true"/>
	    		<custom:column label="#{messages['oneShotChargeInstance.criteria2']}" field="criteria2" isMessage="true"/>
	    		<custom:column label="#{messages['oneShotChargeInstance.criteria3']}" field="criteria3" isMessage="true"/>
    			
    			<rich:column styleClass="actions-column">
             		<f:facet name="header">
                    	<h:outputText value="#{messages['commons.actions']}" />
             		</f:facet>
             		 <a:commandLink id="editRecurringChgInsLink" reRender="recurringChgSdiv" onclick="document.getElementById('recurringChgDiv').style.display='';" action="#{subscriptionBean.editRecurringChargeIns(entity)}">
                		<h:graphicImage value="/img/edit.gif" style="border:0"/>
             		</a:commandLink>
             		<rich:toolTip for="editRecurringChgInsLink" value="#{messages['commons.edit']}"/>
             	</rich:column>
	</custom:dataList>
</a:outputPanel>
	<rich:panel>
<div id="recurringChgDiv" style="display:none"><s:div id="recurringChgSdiv">
	<custom:formPanel edit="true" label="#{messages['subscription.tab.recurringShotChg']}" backingBean="#{subscriptionBean}" 
			entity="#{recurringChargeInstance}" formId="recurringChgForm1" showFormButtons="false" ajaxSubmit="true" >
			<custom:formEntityField id="RCchargeTemplateSelectId" label="#{messages['businessEntity.code']}"
								field="chargeTemplate" childField="code" popup="true" popupId="recurringChargeTmpPopup"/>
				<custom:formField label="#{messages['businessEntity.description']}" field="description" size="50" maxlength="50" disabled="true"/>
				<custom:formField label="#{messages['recurringChargeInstance.subscriptionDate']}" field="subscriptionDate" />
	    		<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['recurringChargeInstance.amountWithoutTax']}" />
				</ui:define>
				<h:inputText rendered="#{edit}" id="RCamountWithoutTax" 
					value="#{entity.amountWithoutTax}" size="5" converter="bigDecimalConverter" onkeyup="validateAmountsRC();" disabled="#{recurringChargeInstance.id!=null and !recurringChargeInstance.chargeTemplate.amountEditable}">
				</h:inputText>		 			
					<h:outputText rendered="#{!edit}" value="#{entity.amountWithoutTax}" style="font-weight:bold;"  converter="bigDecimalConverter" />
				</s:decorate>
	    		<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['recurringChargeInstance.amount2']}" /> 
				</ui:define>
				<h:inputText rendered="#{edit}" id="RCamount2" 
					value="#{entity.amount2}" size="5" converter="bigDecimalConverter" onkeyup="validateAmountsRC();" disabled="#{recurringChargeInstance.id!=null and !recurringChargeInstance.chargeTemplate.amountEditable}"> 
				</h:inputText>						
					<h:outputText rendered="#{!edit}" value="#{entity.amount2}" style="font-weight:bold;"  converter="bigDecimalConverter" />
				</s:decorate>
	    		<custom:formField label="#{messages['recurringChargeInstance.criteria1']}" field="criteria1" disabled="#{recurringChargeInstance.id!=null and !recurringChargeInstance.chargeTemplate.amountEditable}"/>
	    		<custom:formField label="#{messages['recurringChargeInstance.criteria2']}" field="criteria2" disabled="#{recurringChargeInstance.id!=null and !recurringChargeInstance.chargeTemplate.amountEditable}"/>
	    		<custom:formField label="#{messages['recurringChargeInstance.criteria3']}" field="criteria3" disabled="#{recurringChargeInstance.id!=null and !recurringChargeInstance.chargeTemplate.amountEditable}"/>
				<s:decorate template="/layout/edit.xhtml">
					<ui:define name="label">
					<h:outputText value="#{messages['serviceInstance.quantity']}"/>
				</ui:define>
				<rich:inputNumberSpinner required="true" id="quantityRecCH" minValue="1" value="#{subscriptionBean.recurringChargeServiceInstanceQuantity}"/>
				</s:decorate>
	    		<a:outputPanel id="recurringChargeApplicationsPanel">
					<rich:spacer />
					<h:outputText value="#{messages['commons.noItems']}" rendered="#{empty subscriptionBean.recurringChargeApplications}" />
					<h:panelGrid width="100%" columns="1" border="0" style="padding:0px; margin:0px;text-align: right;" rendered="#{not empty subscriptionBean.recurringChargeApplications}">
			        	<h:outputText value="#{subscriptionBean.recurringChargeApplications.size} #{messages['commons.itemsFound']}"/>
	           		<rich:dataTable id="recurringChargeApplicationTable" value="#{subscriptionBean.recurringChargeApplications}" var="shotApplication"
						onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
						onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'"
						reRender="recurringChargeApplicationScroller" rows="10" >
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.applicationDate']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.applicationDate}" >
								<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
							</h:outputText>
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.description']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.description}" >
								<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
							</h:outputText>
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.parameter2']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.parameter2}" >
							</h:outputText>
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.amountWithoutTax']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.amountWithoutTax}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.amount2']}" />
							</f:facet>
							<h:outputText value="#{shotApplication.amount2}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">
								<h:outputText value="#{messages['chargeApplication.status']}" />
							</f:facet>
							<h:outputText value="#{messages[shotApplication.status.label]}" />
						</rich:column>
						
					</rich:dataTable>
					<rich:datascroller id="recurringChargeApplicationScroller" for="recurringChargeApplicationTable" renderIfSinglePage="false" maxPages="10"/>
					</h:panelGrid>
				</a:outputPanel>
				<script type="text/javascript">
    //<![CDATA[

    var validAmountRC;
    var amountWithoutTaxRC;
    var chargeTemplateRC;
    var amount2RC;
    var calculatedAmountRC;
    var calculatedAmountWithoutTaxRC;
    var formatedValueRC;
    var formatedValueHTRC;

    function caseTTCamountRC(){
    	if ((document.getElementById('#{rich:clientId('RCamount2')}').value!='')&&(document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value=='')) 
    	{return true;} else {return false;}
    }
    function caseHTamountRC(){
    	if ((document.getElementById('#{rich:clientId('RCamount2')}').value=='')&&(document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value!='')) 
    	{return true;} else {return false;}
    }
    function caseHTandTTCamoutsRC(){
    	if ((document.getElementById('#{rich:clientId('RCamount2')}').value!='')&&(document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value!='')) 
    	{return true;} else {return false;}
    }
	
    function getValidAmoutRC(){
    	validateAmountsRC();
       	return validAmountRC;
    }
    function getValidFormatRC(amountRC){
    	Seam.Component.getInstance("javaScriptAction").getFormatedAmountString(amountRC,function(result) {formatedValueRC=result;});
    }
    function getValidFormatHTRC(amountRC){
    	Seam.Component.getInstance("javaScriptAction").getFormatedAmountString(amountRC,function(result) {formatedValueHTRC=result;});
    }

	function getAlertTextForCaseHTandTTCamoutsRC(){
		var text =  'Attention : pour le Montant HT '+amountWithoutTaxRC +', le Montant TTC attendu est '+calculatedAmountRC+'. Confirmez-vous les montants saisis ?';
		return text;
	}
	function getAlertTextForCaseTTCamountRC(){
		var text =  'Attention : pour le Montant TTC '+amount2RC +', le Montant HT attendu est '+calculatedAmountWithoutTaxRC;
		return text;
	}
	function getAlertTextForCaseHTamountRC(){
		var text =  'Attention : pour le Montant HT '+amountWithoutTaxRC+', le Montant TTC attendu est '+calculatedAmountRC;
		return text;
	}

	var exceptionHandler = function(ex) { alert("Error: " + ex.getMessage()); };
	
	function validateAmountsRC(){
       	amountWithoutTaxRC = document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value; 
    	chargeTemplateRC = document.getElementById('#{rich:clientId('RCchargeTemplateSelectId')}').value;
    	amount2RC = document.getElementById('#{rich:clientId('RCamount2')}').value;
    	if ((document.getElementById('#{rich:clientId('RCamount2')}').value=='')&&(document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value=='')) 
    	{validAmountRC = true;}
    	else {
    		if(document.getElementById('#{rich:clientId('RCamountWithoutTax')}').value!='') {
    	Seam.Component.getInstance("javaScriptAction").calculateOneShotChargeInstanceAmount(chargeTemplateRC, amountWithoutTaxRC,function(result) {calculatedAmountRC=result;}, exceptionHandler);
    	getValidFormatRC(amountWithoutTaxRC);
		amountWithoutTaxRC = formatedValueHTRC;
		}
    	if(document.getElementById('#{rich:clientId('RCamount2')}').value!='') {
    	Seam.Component.getInstance("javaScriptAction").calculateOneShotChargeInstanceAmountWithoutTax(chargeTemplateRC, amount2RC, function(result) {calculatedAmountWithoutTaxRC=result;}, exceptionHandler);
    	getValidFormatRC(amount2RC);
		amount2RC = formatedValueRC;
    	}
    	if (calculatedAmountRC==amount2RC)
		 {validAmountRC = true;}
		 else {validAmountRC = false;}
    	}
	}
	
	function validationRC(){
		var resultValidAmoutRC=getValidAmoutRC();
		if(resultValidAmoutRC==false){
            if(caseTTCamountRC()==true){
                alert(getAlertTextForCaseTTCamountRC());
                return false;
            }
            if(caseHTamountRC()==true){
                alert(getAlertTextForCaseHTamountRC());
                return false;
            }
            if(caseHTandTTCamoutsRC()==true){
                if(!confirm(getAlertTextForCaseHTandTTCamoutsRC())){
                    return false;}
                }
            }
		else {
			return true;
		}
	}

	
    // ]]>
  </script>    
				<h:panelGrid columns="2">
					<h:commandButton action="#{subscriptionBean.saveRecurringChargeIns}" value="#{messages['action.save']}" rendered="#{currentProvider.amountValidation}">
						<a:support event="onclick" reRender="OS_recurring_results_form" 

                    onsubmit="return validationRC();" 

                    oncomplete="document.getElementById('recurringChgDiv').style.display='none';" />

					</h:commandButton>
					
					<a:commandButton action="#subscriptionBean.saveRecurringChargeIns}" value="#{messages['action.save']}" reRender="OS_recurring_results_form" onclick="document.getElementById('recurringChgDiv').style.display='none';" rendered="#{!currentProvider.amountValidation}"/>
					
					
					<s:button value="#{messages['action.cancel']}" onclick="document.getElementById('recurringChgDiv').style.display='none';"/>
				</h:panelGrid>
				
				
			</custom:formPanel>
</s:div></div>
	</rich:panel>
</rich:tab>
</rich:tabPanel>
</rich:panel>

</div>
</h:panelGroup>
</h:panelGrid>

</ui:define>

</ui:composition>
